@page "/chart/{id}"
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject IRepository Repository

<div class="d-flex justify-content-end">
    <div class="px-2">
        <h3>@Id (Last @days Days)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
           
        </h3>
    </div>
    <div class="px-2">
        <div class="form-floating mb-3">
            <select class="form-select" id="floatingInput" placeholder="Days " @bind="@days">
                <option value="0">-- Select Chart Days --</option>
                <option value="1">-- 1 Day --</option>
                <option value="7">-- 7 Days --</option>
                <option value="14">-- 14 Days --</option>
                <option value="30">-- 30 Days --</option>
                <option value="90">-- 90 Days --</option>
                <option value="180">-- 180 Days --</option>
                <option value="365">-- 365 Days --</option>
            </select>
            <label for="floatingInput">Days:</label>
        </div>
    </div>
    <div class="px-2">
        <a @onclick="Reload" class="btn btn-outline-warning ">Reload <i class="bi bi-arrow-clockwise"></i></a>
    </div>        
  
</div>


<canvas id="myChart" width="1200" height="600"></canvas>

<script>
    function createChart(labels, data) {
        const easing = Chart.helpers.easingEffects.easeInQuad;
        const totalDuration = 5000;

        const duration = (ctx) => easing(ctx.index / data.length) * totalDuration / data.length;
        const delay = (ctx) => easing(ctx.index / data.length) * totalDuration;
        const previousY = (ctx) => ctx.index === 0 ? ctx.chart.scales.y.getPixelForValue(100) : ctx.chart.getDatasetMeta(ctx.datasetIndex).data[ctx.index - 1].getProps(['y'], true).y;

        const animation = {
            x: {
                type: 'number',
                easing: 'linear',
                duration: duration,
                from: NaN, 
                delay(ctx) {
                    if (ctx.type !== 'data' || ctx.xStarted) {
                        return 0;
                    }
                    ctx.xStarted = true;
                    return delay(ctx);
                }
            },
            y: {
                type: 'number',
                easing: 'linear',
                duration: duration,
                from: previousY,
                delay(ctx) {
                    if (ctx.type !== 'data' || ctx.yStarted) {
                        return 0;
                    }
                    ctx.yStarted = true;
                    return delay(ctx);
                }
            }
        };

        const ctx = document.getElementById('myChart').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Price in USD',
                    data: data,
                    borderWidth: 1,
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    borderColor: 'rgb(153, 102, 255)',
                    fill: true,
                    tension: 0.5,
                }]
            },
            options: {
                animations: animation,
                scales: {                  
                }
            }
        });
    }
    function destroyChart(chartId) {
        var chart = Chart.getChart(chartId);
        if (chart !== undefined) {
            chart.destroy();
        }
    }
</script>

@code {
    [Parameter]
    public string Id { get; set; }

    public int days { get; set; } = 30;

    public List<double> data { get; set; } = new List<double>();
    public List<string> labels { get; set; } = new List<string>();

    public class CoinGeckoResponse
    {
        public List<List<double>> Prices { get; set; }
    }


    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
             string key = "x_cg_demo_api_key=CG-LdodJKJHhswwReX1G1H8hTjp";
        string url = $"https://api.coingecko.com/api/v3/coins/{Id}/market_chart?vs_currency=usd&days={days}&precision=4&{key}";

        var coinGeckoData = await Http.GetFromJsonAsync<CoinGeckoResponse>(url);
        var prices = coinGeckoData.Prices.Select(price => new { Date = DateTimeOffset.FromUnixTimeMilliseconds((long)price[0]).DateTime, Value = price[1] }).ToList();
        labels = prices.Select(p => p.Date.ToString("yyyy-MM-dd")).ToList();
        data = prices.Select(p => p.Value).ToList();
        await JSRuntime.InvokeVoidAsync("createChart", labels, data);
    }
    private async Task Reload()
    {
        await JSRuntime.InvokeVoidAsync("destroyChart", "myChart");
        await LoadData();
    }
}